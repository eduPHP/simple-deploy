#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="${TEST_PROJECT_ROOT:-$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd ../.. && pwd )}"
LOG_DIR="$BASE_DIR/logs"

mkdir -p "$LOG_DIR"

REPO=${1:-}
BRANCH=${2:-}
COMMIT=${3:-}

echo "$REPO $BRANCH $COMMIT" >>"$LOG_DIR/deploy-invocations.log"

if [[ "${FORCE_DEPLOY_FAILURE:-0}" == "1" ]]; then
  echo "Simulated deploy failure for $REPO $BRANCH $COMMIT" >&2
  exit 1
fi

echo "Simulated deploy success for $REPO $BRANCH $COMMIT" >>"$LOG_DIR/deploy-${BRANCH}-${COMMIT}.log"

exit 0
