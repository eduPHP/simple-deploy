#!/usr/bin/env bash
set -euo pipefail

dir="${1:-.}"
dir="${dir%/}"

cutoff=$(date -d '-5 days' +%Y%m%d)

# find newest 2 folders
latest_two=$(printf "%s\n" "$dir"/[0-9]* | sort -r | head -n2)

for entry in "$dir"/[0-9]*; do
  [[ -d $entry ]] || continue
  day=$(basename "$entry")
  day=${day:0:8}

  if (( day < cutoff )); then
    echo "Removing release history $entry"
    rm -rf "$entry"
  elif ! grep -qx "$entry" <<<"$latest_two"; then
    echo "Keeping release history $entry, removing vendor"
    rm -rf "$entry/vendor"
  else
    echo "Keeping full release history $entry"
  fi
done

