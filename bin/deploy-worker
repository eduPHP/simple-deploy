#!/usr/bin/env bash
set -euo pipefail


BASE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"
source "$BASE_DIR/.env"

LOCKFILE="$BASE_DIR/.deploy.lock"
LOGFILE="$BASE_DIR/worker.log"
REDIS_CLI="redis-cli -u $REDIS_URL"
QUEUE="deploy:queue"

exec 200>"$LOCKFILE"
flock -n 200 || exit 0

log() {
  echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") $*" >>"$LOGFILE"
  echo "$*"
}

MAX_PER_RUN=10
count=0

while (( count < MAX_PER_RUN )); do
  payload="$($REDIS_CLI LPOP "$QUEUE")" || true
  [[ -z "$payload" ]] && break
  ((++count))

  repo=$(jq -r '.repository // empty' <<<"$payload")
  branch=$(jq -r '.branch // empty' <<<"$payload")
  commit=$(jq -r '.commit // empty' <<<"$payload")

  if [[ -z "$repo" || -z "$branch" || -z "$commit" ]]; then
    log "Invalid JSON payload: $payload"
    continue
  fi

  log "Deploying $repo $branch $commit"

  if "$BASE_DIR/bin/deploy" "$repo" "$branch" "$commit" >>"$LOGFILE" 2>&1; then
    log "Deploy success for $repo@$commit"
    wa-msg "$WA_MESSAGE_JID_TO" "✅ Deploy success: $repo $branch $commit"
  else
    log "Deploy failed for $repo@$commit"
    wa-msg "$WA_MESSAGE_JID_TO" "❌ Deploy failed: $repo $branch $commit"
  fi
done
